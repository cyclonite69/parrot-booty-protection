#!/usr/sbin/nft -f

# ------------------------------------------------------------------------------
# Refined nftables for AI Development Workstation (AWS SSM Managed)
# ------------------------------------------------------------------------------
# This configures a strict lockdown while ensuring AI Engines (Cursor, Windsurf, etc.)
# and your hardened DNS setup function perfectly.
# ------------------------------------------------------------------------------

flush ruleset

table inet filter {
    chain input {
        type filter hook input priority filter; policy drop;

        # Local loopback is critical for IDEs talking to their own extension hosts
        iifname "lo" accept comment "Allow all local IDE internal communication"
        
        ct state established,related accept comment "Allow responses to AI/System requests"
        
        ip protocol icmp icmp type { echo-request, destination-unreachable, time-exceeded } accept
        ip6 nexthdr icmpv6 icmpv6 type { echo-request, destination-unreachable, packet-too-big, time-exceeded, parameter-problem } accept
    }

    chain forward {
        type filter hook forward priority filter; policy drop;
    }

    chain output {
        type filter hook output priority filter; policy drop;

        # Allow the IDE to talk to its background processes (LSPs, etc)
        oifname "lo" accept comment "Allow local IDE extension host traffic"
        
        ct state established,related accept comment "Allow established AI/Dev streams"

        # --- DNS & Hardening ---
        tcp dport 853 accept comment "Unbound DNS-over-TLS egress"

        # --- AI Engines & IDE Connectivity ---
        # Port 443 is used by Cursor, Windsurf, VS Code, and Copilot for:
        # - Model inference (OpenAI/Anthropic/etc)
        # - Telemetry & Auth
        # - WebSocket streaming for chat
        tcp dport 443 accept comment "AI Model Inference & IDE APIs (HTTPS/WSS)"

        # --- System & Updates ---
        udp dport 123 accept comment "NTP Time Sync"
        tcp dport 80 accept comment "Apt/HTTP bootstrapping"

        # --- Local AI / Dev Ports (Optional/Uncomment if needed) ---
        # tcp dport 11434 accept comment "Local Ollama API"
        # tcp dport 3000-3010 accept comment "Local Web Dev Servers"

        # NOTE: Port 53 (Standard DNS) is blocked by the default policy (Anti-Leak).
    }
}