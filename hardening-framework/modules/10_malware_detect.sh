#!/bin/bash
# 10_malware_detect.sh - Rootkit & Malware Detection Module
# DESCRIPTION: Installs and configures rkhunter, chkrootkit, and lynis with automated scanning.
# DEPENDENCIES: rkhunter, chkrootkit, lynis, systemd

set -euo pipefail # Fail fast on errors

MODULE_NAME="malware_detect"
MODULE_DESC="Rootkit/Malware Detection Suite"
MODULE_VERSION="1.0"
LOG_DIR="/var/log/security-suite"
RH_SERVICE="/etc/systemd/system/security-scan.service"
RH_TIMER="/etc/systemd/system/security-scan.timer"

install() {
    log_step "Installing Rootkit & Malware Detection Suite"
    
    log_info "1. Installing security auditing tools (rkhunter, chkrootkit, lynis)..."
    apt-get update -q
    DEBIAN_FRONTEND=noninteractive apt-get install -y rkhunter chkrootkit lynis
    log_info "Tools installed."

    log_info "2. Configuring Logging directory: $LOG_DIR"
    mkdir -p "$LOG_DIR"
    chmod 750 "$LOG_DIR"
    log_info "Logging directory created."

    log_info "3. Initializing rkhunter properties (this may take a moment and connects to internet)..."
    rkhunter --propupd --quiet
    log_info "rkhunter properties updated."

    log_info "4. Creating Systemd Timer for Daily Security Scan..."
    
    cat << EOF > "$RH_SERVICE"
[Unit]
Description=Daily Security Integrity Scan
After=network.target

[Service]
Type=oneshot
ExecStartPre=-/bin/rm -f "$LOG_DIR"/rkhunter.log "$LOG_DIR"/chkrootkit.log "$LOG_DIR"/lynis.log
ExecStart=/bin/bash -c '/usr/bin/rkhunter --check --rwo --sk >> "$LOG_DIR"/rkhunter.log 2>&1 || true'
ExecStart=/bin/bash -c '/usr/sbin/chkrootkit -q >> "$LOG_DIR"/chkrootkit.log 2>&1 || true'
ExecStart=/bin/bash -c '/usr/sbin/lynis audit system --quick --log-file "$LOG_DIR"/lynis.log >> /dev/null 2>&1 || true'
EOF
    log_info "Systemd service file created at $RH_SERVICE."

    cat << EOF > "$RH_TIMER"
[Unit]
Description=Run Security Scan Daily

[Timer]
OnCalendar=daily
Persistent=true

[Install]
WantedBy=timers.target
EOF
    log_info "Systemd timer file created at $RH_TIMER."

    log_info "5. Enabling and starting Systemd Timer..."
    systemctl daemon-reload
    systemctl enable --now security-scan.timer
    log_info "Systemd timer enabled and started."

    if verify; then
        log_info "Malware detection suite installed and scheduled successfully."
        return 0
    else
        log_error "Installation verification failed for Malware Detection Suite."
        return 1
    fi
}

status() {
    if systemctl is-active --quiet security-scan.timer 2>/dev/null; then
        echo "active"
    else
        echo "inactive"
    fi
}

verify() {
    log_info "Verifying Malware Detection Suite installation..."
    # Check if tools are installed
    if ! command -v rkhunter >/dev/null; then
        log_error "rkhunter not found."
        return 1
    fi
    if ! command -v chkrootkit >/dev/null; then
        log_error "chkrootkit not found."
        return 1
    fi
    if ! command -v lynis >/dev/null; then
        log_error "lynis not found."
        return 1
    fi
    log_info "All tools (rkhunter, chkrootkit, lynis) are installed."
    
    # Check if timer is active
    if ! systemctl is-active --quiet security-scan.timer; then
        log_error "security-scan.timer is not active."
        return 1
    fi
    log_info "security-scan.timer is active."
    
    # Check if service file exists
    if [ ! -f "$RH_SERVICE" ]; then
        log_error "Security scan service file $RH_SERVICE not found."
        return 1
    fi
    log_info "Security scan service file exists."

    log_info "Malware Detection Suite verified successfully."
    return 0
}

rollback() {
    log_step "Rolling back Malware Detection Suite"
    log_info "Disabling and removing security scan timer and service files..."
    systemctl disable --now security-scan.timer 2>/dev/null || true
    rm "$RH_SERVICE" "$RH_TIMER" 2>/dev/null || true
    systemctl daemon-reload
    log_info "Security scan automation removed."
    
    # We do not uninstall the packages to avoid breaking user workflows, just the automation.
    log_info "Tools (rkhunter, chkrootkit, lynis) remain installed."
}
