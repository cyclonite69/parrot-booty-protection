#!/bin/bash
# 10_malware_detect.sh - Rootkit & Malware Detection Module
# DESCRIPTION: Installs and configures rkhunter, chkrootkit, and lynis with automated scanning.
# DEPENDENCIES: rkhunter, chkrootkit, lynis, systemd

MODULE_NAME="malware_detect"
MODULE_DESC="Rootkit/Malware Detection Suite"
MODULE_VERSION="1.0"
LOG_DIR="/var/log/security-suite"

install() {
    log_info "Installing security auditing tools..."
    
    # 1. Install dependencies
    apt-get update -q
    DEBIAN_FRONTEND=noninteractive apt-get install -y rkhunter chkrootkit lynis

    # 2. Configure Logging
    mkdir -p "$LOG_DIR"
    chmod 750 "$LOG_DIR"

    # 3. Initialize rkhunter
    log_info "Updating rkhunter properties (this may take a moment)..."
    rkhunter --propupd --quiet

    # 4. Create Systemd Timer for Daily Scan
    log_info "Creating daily security scan timer..."
    
    cat << EOF > /etc/systemd/system/security-scan.service
[Unit]
Description=Daily Security Integrity Scan
After=network.target

[Service]
Type=oneshot
ExecStart=/bin/bash -c '/usr/bin/rkhunter --check --rwo --sk >> /var/log/security-suite/rkhunter.log 2>&1 || true'
ExecStart=/bin/bash -c '/usr/sbin/chkrootkit -q >> /var/log/security-suite/chkrootkit.log 2>&1 || true'
ExecStart=/bin/bash -c '/usr/sbin/lynis audit system --quick --log-file /var/log/security-suite/lynis.log >> /dev/null 2>&1 || true'
EOF

    cat << EOF > /etc/systemd/system/security-scan.timer
[Unit]
Description=Run Security Scan Daily

[Timer]
OnCalendar=daily
Persistent=true

[Install]
WantedBy=timers.target
EOF

    # 5. Enable Timer
    systemctl daemon-reload
    systemctl enable --now security-scan.timer

    if verify; then
        log_info "Malware detection suite installed and scheduled."
        return 0
    else
        log_error "Installation verification failed."
        rollback
        return 1
    fi
}

status() {
    if systemctl is-active --quiet security-scan.timer; then
        echo "active"
    else
        echo "inactive"
    fi
}

verify() {
    # Check if tools are installed
    if ! command -v rkhunter >/dev/null || ! command -v chkrootkit >/dev/null || ! command -v lynis >/dev/null; then
        return 1
    fi
    
    # Check if timer is active
    if systemctl is-active --quiet security-scan.timer; then
        return 0
    fi
    return 1
}

rollback() {
    log_info "Removing security scan timer..."
    systemctl disable --now security-scan.timer 2>/dev/null
    rm /etc/systemd/system/security-scan.service /etc/systemd/system/security-scan.timer 2>/dev/null
    systemctl daemon-reload
    
    # We do not uninstall the packages to avoid breaking user workflows, just the automation.
    log_info "Automation removed. Tools (rkhunter, etc.) remain installed."
}
