#!/bin/bash
# hardenctl - Security Control Dashboard
# USAGE: sudo ./hardenctl

# Source core components
source "$(dirname "$0")/core/logger.sh"
source "$(dirname "$0")/core/state_manager.sh"

MODULES_DIR="$(dirname "$0")/modules"
TITLE="Linux Hardening Control Dashboard"
BACKTITLE="Parrot Booty Protection - Modular Security Framework"

# Check Dependencies
check_dependencies() {
    local missing=0
    if ! command -v whiptail >/dev/null; then
        echo "Error: 'whiptail' is required but not installed."
        missing=1
    fi
    if ! command -v jq >/dev/null; then
        echo "Error: 'jq' is required but not installed."
        missing=1
    fi
    if [ $missing -eq 1 ]; then
        echo "Please install missing dependencies: apt-get install whiptail jq"
        exit 1
    fi
}

check_root() {
    if [ "$(id -u)" -ne 0 ]; then
        echo "Error: This script requires root privileges."
        exit 1
    fi
}

get_module_status_color() {
    local module_name="$1"
    local module_script="$MODULES_DIR/$module_name.sh"
    
    # Run in subshell to prevent function pollution
    (
        source "$module_script"
        
        # Check if enabled in state file
        if is_enabled "$module_name" | grep -q "true"; then
            # Check actual runtime status
            if verify >/dev/null 2>&1; then
                echo "ON  (Verified)"
            else
                echo "ERR (Failed)"
            fi
        else
            echo "OFF"
        fi
    )
}

main_menu() {
    while true; do
        options=()
        
        # Load available modules
        for module in "$MODULES_DIR"/*.sh; do
            module_name=$(basename "$module" .sh)
            if [ "$module_name" == "template" ]; then continue; fi
            
            status=$(get_module_status_color "$module_name")
            options+=("$module_name" "$status")
        done
        
        # Add special options
        options+=("----------------" "---")
        options+=("RUN_ALL" "Apply All Modules")
        options+=("VERIFY_ALL" "Verify All Modules")
        
        # Display menu
        # Redirect stderr to stdout to capture choice, stdout to stderr to show menu
        choice=$(whiptail --title "$TITLE" --backtitle "$BACKTITLE" --menu "Select a module to toggle or verify:" 22 78 14 "${options[@]}" 3>&1 1>&2 2>&3)
        
        exit_code=$?
        
        if [ $exit_code -ne 0 ]; then
            # If not Cancel (1) or ESC (255), it might be an error
            if [ $exit_code -ne 1 ] && [ $exit_code -ne 255 ]; then
                echo "Error: Whiptail failed with exit code $exit_code" >&2
                echo "Output: $choice" >&2
            fi
            break # User cancelled or error
        fi
        
        if [ -n "$choice" ]; then
            if [ "$choice" == "RUN_ALL" ]; then
                run_all_modules
            elif [ "$choice" == "VERIFY_ALL" ]; then
                verify_all_modules
            elif [ "$choice" == "----------------" ]; then
                : # Do nothing
            else
                manage_module "$choice"
            fi
        fi
    done
}

manage_module() {
    local module_name="$1"
    local module_script="$MODULES_DIR/$module_name.sh"
    
    source "$module_script"
    
    local current_status="Unknown"
    if is_enabled "$module_name" | grep -q "true"; then
        if verify >/dev/null 2>&1; then
            current_status="Active & Verified"
        else
            current_status="Enabled but Verification Failed"
        fi
        
        action=$(whiptail --title "$module_name" --menu "Status: $current_status\n\nChoose Action:" 15 60 4 \
            "Disable" "Rollback and Disable Module" \
            "Verify" "Run Verification Tests" \
            "Reinstall" "Force Re-run Install Procedure" \
            "Back" "Return to Main Menu" 3>&1 1>&2 2>&3)
            
        case "$action" in
            "Disable")
                if whiptail --yesno "Are you sure you want to rollback $module_name?" 10 50; then
                    rollback
                    save_state "$module_name" "false"
                    whiptail --msgbox "$module_name disabled." 8 40
                fi
                ;;
            "Verify")
                if verify; then
                    whiptail --msgbox "Verification PASSED." 8 40
                else
                    whiptail --msgbox "Verification FAILED." 8 40
                fi
                ;;
            "Reinstall")
                if install; then
                    save_state "$module_name" "true"
                    whiptail --msgbox "Reinstallation Successful." 8 40
                else
                    whiptail --msgbox "Reinstallation Failed." 8 40
                fi
                ;;
        esac

    else
        action=$(whiptail --title "$module_name" --menu "Status: Disabled\n\nChoose Action:" 15 60 3 \
            "Enable" "Install and Enable Module" \
            "Verify" "Check if active (even if disabled)" \
            "Back" "Return to Main Menu" 3>&1 1>&2 2>&3)
            
        case "$action" in
            "Enable")
                if install; then
                    save_state "$module_name" "true"
                    whiptail --msgbox "$module_name enabled successfully." 8 40
                else
                    whiptail --msgbox "Failed to enable $module_name. Check logs." 8 40
                fi
                ;;
            "Verify")
                if verify; then
                    whiptail --msgbox "Module appears ACTIVE (Manual config?)" 8 40
                else
                    whiptail --msgbox "Module is INACTIVE." 8 40
                fi
                ;;
        esac
    fi
}

run_all_modules() {
    if whiptail --yesno "WARNING: This will attempt to install ALL hardening modules.\n\nAre you sure?" 12 60; then
        exec 3>&1
        for module in "$MODULES_DIR"/*.sh; do
            module_name=$(basename "$module" .sh)
            if [ "$module_name" == "template" ]; then continue; fi
            
            # Subshell to protect environment
            (
                source "$module"
                echo "Installing $module_name..."
                if install; then
                    save_state "$module_name" "true"
                    echo "✓ $module_name Installed"
                else
                    echo "✗ $module_name Failed"
                fi
            )
        done | whiptail --progressbox "Running Hardening Suite..." 20 70
        exec 3>&-
        whiptail --msgbox "Batch operation complete. Check logs for details." 8 50
    fi
}

verify_all_modules() {
    result_text=""
    for module in "$MODULES_DIR"/*.sh; do
        module_name=$(basename "$module" .sh)
        if [ "$module_name" == "template" ]; then continue; fi
        
        # Subshell for verification
        status=$(
            source "$module"
            if verify >/dev/null 2>&1; then echo "PASS"; else echo "FAIL/INACTIVE"; fi
        )
        result_text="${result_text}${module_name}: ${status}\n"
    done
    whiptail --title "Verification Report" --msgbox "$result_text" 20 60
}

# --- Entry Point ---
check_root
check_dependencies
init_state
main_menu
