#!/bin/bash
# hardenctl - Security Control Dashboard
# USAGE: sudo ./hardenctl

# Source core components
source "$(dirname "$0")/core/logger.sh"
source "$(dirname "$0")/core/state_manager.sh"

MODULES_DIR="$(dirname "$0")/modules"
TITLE="Linux Hardening Control Dashboard"
BACKTITLE="Parrot Booty Protection - Modular Security Framework"

# --- Global Module Log ---
# This will be set for each module's execution context
MODULE_RUN_LOG=""

# Check Dependencies
check_dependencies() {
    local missing=0
    if [ -z "$TERM" ]; then
        echo "Error: TERM environment variable is not set."
        echo "Try running: export TERM=xterm-256color"
        exit 1
    fi
    if ! command -v whiptail >/dev/null; then
        echo "Error: 'whiptail' is required but not installed."
        missing=1
    fi
    if ! command -v jq >/dev/null; then
        echo "Error: 'jq' is required but not installed."
        missing=1
    fi
    if [ $missing -eq 1 ]; then
        echo "Please install missing dependencies: apt-get install whiptail jq"
        exit 1
    fi
}

check_root() {
    if [ "$(id -u)" -ne 0 ]; then
        echo "Error: This script requires root privileges."
        exit 1
    fi
}

get_module_status_color() {
    local module_name="$1"
    local module_script="$MODULES_DIR/$module_name.sh"
    
    (
        source "$module_script"
        if is_enabled "$module_name" | grep -q "true"; then
            if verify >/dev/null 2>&1; then
                echo "ON  (Verified)"
            else
                echo "ERR (Failed)"
            fi
        else
            echo "OFF"
        fi
    )
}

main_menu() {
    while true; do
        options=()
        
        # Load available modules
        for module in "$MODULES_DIR"/*.sh; do
            module_name=$(basename "$module" .sh)
            if [ "$module_name" == "template" ]; then continue; fi
            
            status=$(get_module_status_color "$module_name")
            options+=("$module_name" "$status")
        done
        
        # Add special options
        options+=("RUN_ALL" "Apply All Modules")
        options+=("VERIFY_ALL" "Verify All Modules")
        
        choice=$(whiptail --title "$TITLE" --backtitle "$BACKTITLE" --menu "Select a module to toggle or verify:" 22 78 14 "${options[@]}" 3>&1 1>&2 2>&3)
        
        exit_code=$?
        
        if [ $exit_code -ne 0 ]; then
            break # User cancelled
        fi
        
        if [ -n "$choice" ]; then
            if [ "$choice" == "RUN_ALL" ]; then
                run_all_modules
            elif [ "$choice" == "VERIFY_ALL" ]; then
                verify_all_modules
            else # If it's not a special option, it must be a module
                manage_module "$choice"
            fi
        fi
    done
}

manage_module() {
    local module_name="$1"
    local module_script="$MODULES_DIR/$module_name.sh"
    
    # Create a temporary log file for this module's run
    MODULE_RUN_LOG=$(mktemp "/tmp/${module_name}_run_XXXXXX.log")
    log_info "Starting $module_name run. Logs to $MODULE_RUN_LOG"

    # Source the module in a subshell, redirecting its output to the log file
    # This also sets MODULE_RUN_LOG for the sourced script if it wants to append to it
    (
        export MODULE_RUN_LOG
        source "$module_script"
        local -a ACTIONS=("install" "rollback" "verify" "status") # All functions that might be called
        
        # Define functions to capture their output if not already defined
        for action in "${ACTIONS[@]}"; do
            if ! declare -f "$action" > /dev/null; then
                eval "$action() { :; }" # Define a dummy function
            fi
        done
        
        local installed=false
        if is_enabled "$module_name" | grep -q "true"; then
            installed=true
        fi

        local current_status="Unknown"
        if $installed; then
            if verify >> "$MODULE_RUN_LOG" 2>&1; then
                current_status="Active & Verified"
            else
                current_status="Enabled but Verification Failed"
            fi
        fi
        
        action=$(whiptail --title "$module_name" --menu "Status: $current_status\n\nChoose Action:" 18 70 5 \
            "Enable" "Install and Enable Module" \
            "Disable" "Rollback and Disable Module" \
            "Verify" "Run Verification Tests" \
            "Reinstall" "Force Re-run Install Procedure" \
            "ViewLog" "View Last Operation Log" \
            "Back" "Return to Main Menu" 3>&1 1>&2 2>&3)
            
        case "$action" in
            "Enable")
                if ! $installed; then # Only enable if not already installed
                    if install >> "$MODULE_RUN_LOG" 2>&1; then
                        save_state "$module_name" "true"
                        whiptail --msgbox "$module_name enabled successfully. See log for details." 8 50
                    else
                        whiptail --msgbox "Failed to enable $module_name. See log for details." 8 50
                    fi
                else
                    whiptail --msgbox "$module_name is already enabled. Use Reinstall to re-run." 8 50
                fi
                ;;
            "Disable")
                if $installed; then # Only disable if installed
                    if whiptail --yesno "Are you sure you want to rollback $module_name?" 10 50; then
                        rollback >> "$MODULE_RUN_LOG" 2>&1
                        save_state "$module_name" "false"
                        whiptail --msgbox "$module_name disabled. See log for details." 8 40
                    fi
                else
                    whiptail --msgbox "$module_name is not enabled." 8 50
                fi
                ;;
            "Verify")
                if verify >> "$MODULE_RUN_LOG" 2>&1; then
                    whiptail --msgbox "Verification PASSED. See log for details." 8 40
                else
                    whiptail --msgbox "Verification FAILED. See log for details." 8 40
                fi
                ;;
            "Reinstall")
                if whiptail --yesno "Are you sure you want to force reinstall $module_name?" 10 50; then
                    # Force a rollback first, then install
                    rollback >> "$MODULE_RUN_LOG" 2>&1
                    install >> "$MODULE_RUN_LOG" 2>&1
                    if [ $? -eq 0 ]; then
                        save_state "$module_name" "true"
                        whiptail --msgbox "Reinstallation Successful. See log for details." 8 50
                    else
                        whiptail --msgbox "Reinstallation Failed. See log for details." 8 50
                    fi
                fi
                ;;
            "ViewLog")
                if [ -s "$MODULE_RUN_LOG" ]; then # Check if log file exists and is not empty
                    whiptail --textbox "$MODULE_RUN_LOG" 25 80
                else
                    whiptail --msgbox "No log content available for this run." 8 50
                fi
                ;;
        esac
    ) # End of subshell for module execution

    # Clean up temp log file
    rm -f "$MODULE_RUN_LOG" 2>/dev/null
}


run_all_modules() {
    if whiptail --yesno "WARNING: This will attempt to install ALL hardening modules.\n\nAre you sure?" 12 60; then
        exec 3>&1
        local -a module_run_results=()
        for module in "$MODULES_DIR"/*.sh; do
            module_name=$(basename "$module" .sh)
            if [ "$module_name" == "template" ]; then continue; fi
            
            # Create a temporary log for this module's batch run
            MODULE_RUN_LOG=$(mktemp "/tmp/${module_name}_batch_XXXXXX.log")
            log_info "Starting $module_name batch run. Logs to $MODULE_RUN_LOG"

            # Subshell to protect environment and capture output
            (
                export MODULE_RUN_LOG
                source "$module"
                echo "Installing $module_name..."
                if install >> "$MODULE_RUN_LOG" 2>&1; then
                    save_state "$module_name" "true"
                    echo "✓ $module_name Installed"
                    module_run_results+=("✓ $module_name")
                else
                    echo "✗ $module_name Failed (See log: $MODULE_RUN_LOG)"
                    module_run_results+=("✗ $module_name")
                fi
            ) | whiptail --progressbox "Running Hardening Suite..." 20 70 # Progressbox might not work with this redirection
            
            rm -f "$MODULE_RUN_LOG" 2>/dev/null # Clean up temp log after module run
        done
        exec 3>&-
        whiptail --msgbox "Batch operation complete. Check individual logs and /var/log/hardenctl.log for details.\n\nResults:\n${module_run_results[*]}" 25 80
    fi
}

verify_all_modules() {
    result_text=""
    for module in "$MODULES_DIR"/*.sh; do
        module_name=$(basename "$module" .sh)
        if [ "$module_name" == "template" ]; then continue; fi
        
        # Subshell for verification
        status=$(
            source "$module"
            if verify >/dev/null 2>&1; then echo "PASS"; else echo "FAIL/INACTIVE"; fi
        )
        result_text="${result_text}${module_name}: ${status}\n"
    done
    whiptail --title "Verification Report" --msgbox "$result_text" 20 60
}

# --- Entry Point ---
check_root
check_dependencies
init_state
main_menu
